<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Emotion Reading Task</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      max-width: 800px;
      margin: 24px auto;
      padding: 0 16px;
      font-family: system-ui, Segoe UI, Arial, sans-serif;
    }
    h2 { margin-bottom: 8px; }
    .error {
      color: #b00020;
      background: #fdecee;
      padding: 12px;
      border-left: 4px solid #b00020;
    }
    .block { margin: 24px 0; }
    .line {
      padding: 10px 12px;
      border-left: 4px solid #ccc;
      background: #f7f7f7;
      margin: 8px 0;
    }
    .meta {
      margin: 6px 0 0;
      color: #666;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <h2>Emotion Reading Task</h2>
  <div id="content">Loading…</div>

  <script type="module">
    const API = "https://script.google.com/macros/s/AKfycbwq970N9tIv10WxcmU-CQCHxWexIQRDfUTHbtYynhuglic3jYB4BnLK8Lz2h2fwe6Si/exec";

    async function getAssignment() {
      const saved = localStorage.getItem("survey_token") || "";
      const url = saved ? `${API}?token=${encodeURIComponent(saved)}` : API;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`API error ${r.status}`);
      const data = await r.json();
      if (data.token && data.token !== saved)
        localStorage.setItem("survey_token", data.token);
      if (!data.lines)
        throw new Error(data.error || "No lines returned");
      return data;
    }

    function render(assign) {
      const instr = {
        Happy:    "Please read the following with a <b>happy, joyful tone</b>:",
        Sad:      "Please read the following with a <b>sad tone</b>:",
        Surprised:"Please read the following with a <b>surprised tone</b>:",
        Angry:    "Please read the following with an <b>angry tone</b>:",
        Neutral:  "Please read the following in a <b>calm, neutral tone</b>:"
      };

      let html = `<p><b>Participant ID:</b> ${assign.participant_id}</p>`;

      for (const [emotion, line] of Object.entries(assign.lines)) {
        const nice = emotion.charAt(0).toUpperCase() + emotion.slice(1);
        html += `
          <div class="block">
            <h3>${nice}</h3>
            <p>${instr[nice] || "Please read the following:"}</p>
            <div class="line">${line || "(no text found)"}</div>
            <p class="meta"><i>row = PID, sheet = '${nice}'</i></p>
          </div>
        `;
      }

      document.getElementById("content").innerHTML = html;
    }

    (async () => {
      try {
        const assign = await getAssignment();
        render(assign);
      } catch (e) {
        document.getElementById("content").innerHTML =
          `<div class="error"><b>Couldn’t load tasks.</b> ${String(e)}</div>`;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
